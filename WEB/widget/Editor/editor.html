<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Editor</title>
    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" href="theme/rubyblue.css">
    <link rel="stylesheet" href="addon/fold/foldgutter.css" />
    <link rel="stylesheet" href="addon/lint/lint.css" />
    <script src="lib/codemirror.js"></script>
    <script src="lib/jquery.min.js"></script>

    <script src="mode/javascript/javascript.js"></script>
    <script src="mode/xml/xml.js"></script>
    <script src="mode/css/css.js"></script>
    <script src="mode/htmlmixed/htmlmixed.js"></script>

    <script src="addon/fold/foldcode.js"></script>
    <script src="addon/fold/foldgutter.js"></script>
    <script src="addon/fold/brace-fold.js"></script>
    <script src="addon/fold/comment-fold.js"></script>

    <script src="addon/lint/lint.js"></script>
    <script src="addon/lint/javascript-lint.js"></script>
    <script src="addon/lint/json-lint.js"></script>
    <script src="addon/lint/css-lint.js"></script>
    <script src="addon/lint/html-lint.js"></script>

    <script src="addon/edit/closetag.js"></script>
    <script src="addon/edit/closebrackets.js"></script>
    <script src="addon/display/placeholder.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #container {
            width: 1000px;
            height: 1280px;
        }

        #container>div {
            float: left;
            height: 1280px;
        }

        #container>div:nth-of-type(1) {
            width: 640px;
        }

        #container>div:nth-of-type(2) {
            width: 360px;
        }

        #container>div>div {
            height: 640px;
            border: 1px solid #666666;
        }

        #container>div:nth-of-type(1)>div {
            width: 640px;
        }

        #container>div:nth-of-type(2)>div {
            width: 360px;
        }

        #output>iframe {
            width: 100%;
            height: 100%;
        }

        #run_btn {
            width: 80px;
            height: 40px;
        }
    </style>
</head>

<body>
    <div id="container">
        <div>
            <div>
                <textarea id="html_text" cols="30" rows="10" style="display:none;" placeholder="请输入HTML"></textarea>
            </div>
            <div>
                <textarea id="js_text" cols="30" rows="10" style="display:none;" placeholder="请输入JS"></textarea>
            </div>
        </div>
        <div>
            <div>
                <textarea id="css_text" cols="30" rows="10" style="display:none;" placeholder="请输入CSS"></textarea>
            </div>
            <div id="output"></div>
        </div>
    </div>
    <div><button id="run_btn">run</button></div>


    <script>
        $(document).ready(function () {
            //html editor
            html_editor = CodeMirror.fromTextArea(document.querySelector("#html_text"), html_opt);
            html_editor.setSize('100%', '100%');
            // html_editor.on('change', function (inst, changes) {
            //     runTextarea();
            // });

            //js editor
            js_editor = CodeMirror.fromTextArea(document.querySelector("#js_text"), js_opt);
            js_editor.setSize('100%', '100%');
            // js_editor.on('change', function (inst, changes) {
            //     runTextarea();
            // });

            //css editor
            css_editor = CodeMirror.fromTextArea(document.querySelector("#css_text"), html_opt);
            css_editor.setSize('100%', '100%');
            // css_editor.on('change', function (inst, changes) {
            //     runTextarea();
            // });
        });

        //option
        var html_opt = {
            mode: 'text/html',
            theme: 'rubyblue',
            indentUnit: 4,
            gutter: true,
            lineNumbers: true,
            styleActiveLine: true,
            autoCloseBrackets: true,
            lineWrapping: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter","CodeMirror-lint-markers"],
            matchBrackets: true,
            autoCloseTags: true
        };

        var js_opt = {
            mode: 'javascript',
            theme: 'rubyblue',
            indentUnit: 4,
            gutter: true,
            lineNumbers: true,
            styleActiveLine: true,
            autoCloseBrackets: true,
            lineWrapping: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter","CodeMirror-lint-markers"],
            matchBrackets: true,
            autoCloseTags: true
        };

        $('#run_btn').on('click', function () {
            runTextarea();
        });

        function runTextarea() {
            var html = html_editor.getValue(),
                css = css_editor.getValue(),
                js = js_editor.getValue(),
                src = html;

            if (html) {
                var patternHtmlTag = /<html([^>]*)>/im;
                var array_matches_html_tag = patternHtmlTag.exec(src);
                if (array_matches_html_tag) {
                    src = src.replace('<html>', '<html ' + array_matches_html_tag[1] + '>');
                }
                var patternHead = /<head[^>]*>((.|[\n\r])*)<\/head>/im
                var array_matches_head = patternHead.exec(src);

                var patternBodyTag = /<body([^>]*)>/im;
                var array_matches_body_tag = patternBodyTag.exec(src);
                if (array_matches_body_tag) {
                    src = src.replace('<body>', '<body ' + array_matches_body_tag[1] + '>');
                }
            }

            // if (css.indexOf('<style>') !== -1) {
            //     $(".alert-danger span").text('CSS 编辑框不需要 <style> 标签');
            //     $(".alert-danger").show().delay(5000).fadeOut();
            //     return;
            // } else if (js.indexOf('<script>') !== -1) {
            //     $(".alert-danger span").text('JavaScript 编辑框不需要 <script> 标签');
            //     $(".alert-danger").show().delay(5000).fadeOut();
            //     return;
            // } else {
            //     $(".alert-danger").hide();
            // }

            // CSS
            if (css) {
                css = '<style>' + css + '</style>';
                if (array_matches_head) {
                    src = src.replace('</head>', css + '</head>');
                } else if (array_matches_body_tag) {
                    src = src.replace('</body>', css + '</body>');
                } else {
                    src += css;
                }
            }

            // Javascript
            if (js) {
                js = '<script>' + js + '<\/script>';
                if (array_matches_body_tag) {
                    src = src.replace('</body>', js + '</body>');
                } else {
                    src += js;
                }
            }

            // iframe
            var ifr = document.createElement("iframe");
            ifr.setAttribute("frameborder", "0");
            ifr.setAttribute("id", "iframeResult");
            document.getElementById("output").innerHTML = "";
            document.getElementById("output").appendChild(ifr);

            var ifrw = (ifr.contentWindow) ? ifr.contentWindow : (ifr.contentDocument.document) ? ifr.contentDocument.document : ifr.contentDocument;
            ifrw.document.open();
            ifrw.document.write(src);
            ifrw.document.close();
        }
    </script>
    

</body>

</html>