<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Editor</title>
    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" href="theme/rubyblue.css">
    <script src="lib/codemirror.js"></script>
    <script src="lib/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #container {
            width: 1200px;
            height: 800px;
        }
        #container>div {
            float: left;
            width: 600px;
            height: 800px;
        }
        #container>div>div {
            width: 600px;
            height: 400px;
            border: 1px solid #666666;
        }
        #output>iframe {
            width: 100%;
            height: 100%;
        }
        #run_btn{
            width: 80px;
            height: 40px;
        }
    </style>
</head>

<body>
    <div id="container">
        <div>
            <div>
                <textarea id="html_text" cols="30" rows="10" style="display:none;" placeholder="请输入HTML"></textarea>
            </div>
            <div>
                <textarea id="js_text" cols="30" rows="10" style="display:none;" placeholder="请输入JS"></textarea>
            </div>
        </div>
        <div>
            <div>
                <textarea id="css_text" cols="30" rows="10" style="display:none;" placeholder="请输入CSS"></textarea>
            </div>
            <div id="output"></div>
        </div>
    </div>
    <div><button id="run_btn">run</button></div>


    <script>
        $(document).ready(function () {


        });

        //option
        var cm_opt = {
            mode: 'text/html',
            theme: 'rubyblue',
            gutter: true,
            lineNumbers: true,
            autoCloseBrackets: true,
            lineWrapping: true,
            matchBrackets: true,
            autoCloseTags: true
        };

        //html editor
        var html_editor = CodeMirror.fromTextArea(document.querySelector("#html_text"), cm_opt);
        html_editor.setSize('100%', '100%');
        // html_editor.on('change', function (inst, changes) {
        //     runTextarea();
        // });

        //js editor
        var js_editor = CodeMirror.fromTextArea(document.querySelector("#js_text"), cm_opt);
        js_editor.setSize('100%', '100%');
        // js_editor.on('change', function (inst, changes) {
        //     runTextarea();
        // });

        //css editor
        var css_editor = CodeMirror.fromTextArea(document.querySelector("#css_text"), cm_opt);
        css_editor.setSize('100%', '100%');
        // css_editor.on('change', function (inst, changes) {
        //     runTextarea();
        // });

        $('#run_btn').on('click', function() {
            runTextarea();
        });

        function runTextarea() {
            var html = html_editor.getValue(),
                css = css_editor.getValue(),
                js = js_editor.getValue(),
                src = html;

            if (html) {
                var patternHtmlTag = /<html([^>]*)>/im;
                var array_matches_html_tag = patternHtmlTag.exec(src);
                if (array_matches_html_tag) {
                    src = src.replace('<html>', '<html ' + array_matches_html_tag[1] + '>');
                }
                var patternHead = /<head[^>]*>((.|[\n\r])*)<\/head>/im
                var array_matches_head = patternHead.exec(src);

                var patternBodyTag = /<body([^>]*)>/im;
                var array_matches_body_tag = patternBodyTag.exec(src);
                if (array_matches_body_tag) {
                    src = src.replace('<body>', '<body ' + array_matches_body_tag[1] + '>');
                }
            }

            // if (css.indexOf('<style>') !== -1) {
            //     $(".alert-danger span").text('CSS 编辑框不需要 <style> 标签');
            //     $(".alert-danger").show().delay(5000).fadeOut();
            //     return;
            // } else if (js.indexOf('<script>') !== -1) {
            //     $(".alert-danger span").text('JavaScript 编辑框不需要 <script> 标签');
            //     $(".alert-danger").show().delay(5000).fadeOut();
            //     return;
            // } else {
            //     $(".alert-danger").hide();
            // }

            // CSS
            if (css) {
                css = '<style>' + css + '</style>';
                if (array_matches_head) {
                    src = src.replace('</head>', css + '</head>');
                } else if (array_matches_body_tag) {
                    src = src.replace('</body>', css + '</body>');
                } else {
                    src += css;
                }
            }

            // Javascript
            if (js) {
                js = '<script>' + js + '<\/script>';
                if (array_matches_body_tag) {
                    src = src.replace('</body>', js + '</body>');
                } else {
                    src += js;
                }
            }

            // iframe
            var ifr = document.createElement("iframe");
            ifr.setAttribute("frameborder", "0");
            ifr.setAttribute("id", "iframeResult");
            document.getElementById("output").innerHTML = "";
            document.getElementById("output").appendChild(ifr);

            var ifrw = (ifr.contentWindow) ? ifr.contentWindow : (ifr.contentDocument.document) ? ifr.contentDocument.document : ifr.contentDocument;
            ifrw.document.open();
            ifrw.document.write(src);
            ifrw.document.close();
        }
    </script>
</body>

</html>