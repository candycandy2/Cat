<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Editor</title>
    <!--CodeMirror-->
    <link rel="stylesheet" href="lib/codemirror.css" />
    <link rel="stylesheet" href="theme/rubyblue.css" />
    <link rel="stylesheet" href="addon/fold/foldgutter.css" />
    <link rel="stylesheet" href="addon/lint/lint.css" />
    <!--treeview-->
    <link rel="stylesheet" href="lib/jquery.treeview.css" />
    <link rel="stylesheet" href="lib/screen.css" />
    <!--self-->
    <link rel="stylesheet" href="editor.css" />


    <script src="lib/jquery.min.js"></script>
    <script src="lib/codemirror.js"></script>
    <script src="lib/jquery.treeview.js"></script>
    <script src="lib/jquery.cookie.js"></script>

    <script src="mode/javascript/javascript.js"></script>
    <script src="mode/xml/xml.js"></script>
    <script src="mode/css/css.js"></script>
    <script src="mode/htmlmixed/htmlmixed.js"></script>

    <script src="addon/fold/foldcode.js"></script>
    <script src="addon/fold/foldgutter.js"></script>
    <script src="addon/fold/brace-fold.js"></script>
    <script src="addon/fold/comment-fold.js"></script>

    <script src="addon/lint/lint.js"></script>
    <script src="addon/lint/javascript-lint.js"></script>
    <script src="addon/lint/json-lint.js"></script>
    <script src="addon/lint/css-lint.js"></script>
    <script src="addon/lint/html-lint.js"></script>

    <script src="addon/edit/closetag.js"></script>
    <script src="addon/edit/closebrackets.js"></script>
    <script src="addon/display/placeholder.js"></script>

    <style>

    </style>
</head>

<body>
    <div id="editMain">
        <!--treeview-->
        <div id="treeview">
            <div id="btnList">
                <ul>
                    <li id="createBtn"><button>new</button></li>
                    <li><button>open</button></li>
                    <li><button>save</button></li>
                    <li id="runBtn"><button>run</button></li>
                </ul>
            </div>
            <ul id="treeviewMenu" class="filetree">
                <li><span class="folder">allen.z.yuan</span>
                    <ul>
                        <li><span class="folder">widget</span>
                            <ul>
                                <li><span class="folder">movie</span>
									<ul>
										<li><span class="file">movie.css</span></li>
										<li><span class="file">movie.html</span></li>
										<li><span class="file">movie.js</span></li>
									</ul>
								</li>
								<li><span class="folder">football</span></li>
                            </ul>
                        </li>
                        <li><span class="folder">widgetPage</span>
                            <ul>
                                <li><span class="folder">allMovies</span>
									<ul>
										<li><span class="file">allMovies.css</span></li>
										<li><span class="file">allMovies.html</span></li>
										<li><span class="file">allMovies.js</span></li>
									</ul>
								</li>
                                <li><span class="folder">newMovies</span>
									<ul>
										<li><span class="file">newMovies.css</span></li>
										<li><span class="file">newMovies.html</span></li>
										<li><span class="file">newMovies.js</span></li>
									</ul>
								</li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        <div id="toggleTreeview"></div>
        <!--editor-->
        <div id="editor">
            <div>
                <div>
                    <textarea id="html_text" cols="30" rows="10" style="display:none;" placeholder="请输入HTML"></textarea>
                </div>
                <div>
                    <textarea id="js_text" cols="30" rows="10" style="display:none;" placeholder="请输入JS"></textarea>
                </div>
            </div>
            <div>
                <div>
                    <textarea id="css_text" cols="30" rows="10" style="display:none;" placeholder="请输入CSS"></textarea>
                </div>
                <div id="output"></div>
            </div>
        </div>
    </div>


    <script>
        $(document).ready(function () {
            //html editor
            html_editor = CodeMirror.fromTextArea(document.querySelector("#html_text"), html_opt);
            html_editor.setSize('100%', '100%');
            // html_editor.on('change', function (inst, changes) {
            //     runTextarea();
            // });

            //js editor
            js_editor = CodeMirror.fromTextArea(document.querySelector("#js_text"), js_opt);
            js_editor.setSize('100%', '100%');
            // js_editor.on('change', function (inst, changes) {
            //     runTextarea();
            // });

            //css editor
            css_editor = CodeMirror.fromTextArea(document.querySelector("#css_text"), html_opt);
            css_editor.setSize('100%', '100%');
            // css_editor.on('change', function (inst, changes) {
            //     runTextarea();
            // });

            $('#treeviewMenu').treeview();
        });

        //option
        var html_opt = {
            mode: 'text/html',
            theme: 'rubyblue',
            indentUnit: 4,
            gutter: true,
            lineNumbers: true,
            styleActiveLine: true,
            autoCloseBrackets: true,
            lineWrapping: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"],
            matchBrackets: true,
            autoCloseTags: true
        };

        var js_opt = {
            mode: 'javascript',
            theme: 'rubyblue',
            indentUnit: 4,
            gutter: true,
            lineNumbers: true,
            styleActiveLine: true,
            autoCloseBrackets: true,
            lineWrapping: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"],
            matchBrackets: true,
            autoCloseTags: true
        };

        $('#runBtn').on('click', function () {
            runTextarea();
        });

        function runTextarea() {
            var html = html_editor.getValue(),
                css = css_editor.getValue(),
                js = js_editor.getValue(),
                src = html;

            if (html) {
                var patternHtmlTag = /<html([^>]*)>/im;
                var array_matches_html_tag = patternHtmlTag.exec(src);
                if (array_matches_html_tag) {
                    src = src.replace('<html>', '<html ' + array_matches_html_tag[1] + '>');
                }
                var patternHead = /<head[^>]*>((.|[\n\r])*)<\/head>/im
                var array_matches_head = patternHead.exec(src);

                var patternBodyTag = /<body([^>]*)>/im;
                var array_matches_body_tag = patternBodyTag.exec(src);
                if (array_matches_body_tag) {
                    src = src.replace('<body>', '<body ' + array_matches_body_tag[1] + '>');
                }
            }

            // if (css.indexOf('<style>') !== -1) {
            //     $(".alert-danger span").text('CSS 编辑框不需要 <style> 标签');
            //     $(".alert-danger").show().delay(5000).fadeOut();
            //     return;
            // } else if (js.indexOf('<script>') !== -1) {
            //     $(".alert-danger span").text('JavaScript 编辑框不需要 <script> 标签');
            //     $(".alert-danger").show().delay(5000).fadeOut();
            //     return;
            // } else {
            //     $(".alert-danger").hide();
            // }

            // CSS
            if (css) {
                css = '<style>' + css + '</style>';
                if (array_matches_head) {
                    src = src.replace('</head>', css + '</head>');
                } else if (array_matches_body_tag) {
                    src = src.replace('</body>', css + '</body>');
                } else {
                    src += css;
                }
            }

            // Javascript
            if (js) {
                js = '<script>' + js + '<\/script>';
                if (array_matches_body_tag) {
                    src = src.replace('</body>', js + '</body>');
                } else {
                    src += js;
                }
            }

            // iframe
            var ifr = document.createElement("iframe");
            ifr.setAttribute("frameborder", "0");
            ifr.setAttribute("id", "iframeResult");
            document.getElementById("output").innerHTML = "";
            document.getElementById("output").appendChild(ifr);

            var ifrw = (ifr.contentWindow) ? ifr.contentWindow : (ifr.contentDocument.document) ? ifr.contentDocument.document : ifr.contentDocument;
            ifrw.document.open();
            ifrw.document.write(src);
            ifrw.document.close();
        }

        $("#createBtn").on('click', function () {
            var html_code = "<!DOCTYPE html>\n<html>\n<head>\n<meta charset=\"utf-8\">\n<title>文档标题</title>\n</head>\n<body>\n\t<h1>Hello World</h1>\n</body>\n</html>\n";
            html_editor.getDoc().setValue(html_code);

            var css_code = "h1{color: red}";
            css_editor.getDoc().setValue(css_code);

            var js_code = "alert('helloworld');";
            js_editor.getDoc().setValue(js_code);
        });

        $('#toggleTreeview').on('click', function () {
            let show = $('#treeview').css('display');
            if (show == 'block') {
                $('#treeview').css('display', 'none');
            } else {
                $('#treeview').css('display', 'block');
            }
        });

    </script>


</body>

</html>