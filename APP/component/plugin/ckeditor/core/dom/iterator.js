"use strict";!function(){function e(e){arguments.length<1||(this.range=e,this.forceBrBreak=0,this.enlargeBr=1,this.enforceRealBlocks=0,this._||(this._={}))}function t(){var e,t=this.range.clone(),r=t.startPath(),n=t.endPath(),a=!t.collapsed&&o(t,r.block),i=!t.collapsed&&o(t,n.block,1);if(t.shrink(CKEDITOR.SHRINK_ELEMENT,!0),a&&t.setStartAt(r.block,CKEDITOR.POSITION_BEFORE_END),i&&t.setEndAt(n.block,CKEDITOR.POSITION_AFTER_START),e=t.endContainer.hasAscendant("pre",!0)||t.startContainer.hasAscendant("pre",!0),t.enlarge(this.forceBrBreak&&!e||!this.enlargeBr?CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS:CKEDITOR.ENLARGE_BLOCK_CONTENTS),!t.collapsed){var s=new CKEDITOR.dom.walker(t.clone()),l=CKEDITOR.dom.walker.bookmark(!0,!0);s.evaluator=l,this._.nextNode=s.next(),(s=new CKEDITOR.dom.walker(t.clone())).evaluator=l;var c=s.previous();if(this._.lastNode=c.getNextSourceNode(!0,null,t.root),this._.lastNode&&this._.lastNode.type==CKEDITOR.NODE_TEXT&&!CKEDITOR.tools.trim(this._.lastNode.getText())&&this._.lastNode.getParent().isBlockBoundary()){var d=this.range.clone();if(d.moveToPosition(this._.lastNode,CKEDITOR.POSITION_AFTER_END),d.checkEndOfBlock()){var E=new CKEDITOR.dom.elementPath(d.endContainer,d.root),h=E.block||E.blockLimit;this._.lastNode=h.getNextSourceNode(!0)}}this._.lastNode&&t.root.contains(this._.lastNode)||(this._.lastNode=this._.docEndMarker=t.document.createText(""),this._.lastNode.insertAfter(c)),t=null}return this._.started=1,t}function r(e,t){null==t&&(t=a(e));for(var r;r=t.shift();)if(n(r))return{element:r,remaining:t};return null}function n(e){return e.getDtd().p}function a(e){var t=[];return e.forEach(function(e){if("true"==e.getAttribute("contenteditable"))return t.push(e),!1},CKEDITOR.NODE_ELEMENT,!0),t}function i(e,t,n,a){var o=r(n,a);if(!o)return 0;var s=CKEDITOR.filter.instances[o.element.data("cke-filter")];if(s&&!s.check(t))return i(e,t,n,o.remaining);var l=new CKEDITOR.dom.range(o.element);l.selectNodeContents(o.element);var c=l.createIterator();return c.enlargeBr=e.enlargeBr,c.enforceRealBlocks=e.enforceRealBlocks,c.activeFilter=c.filter=s,e._.nestedEditable={element:o.element,container:n,remaining:o.remaining,iterator:c},1}function o(e,t,r){if(!t)return!1;var n=e.clone();return n.collapse(!r),n.checkBoundaryOfElement(t,r?CKEDITOR.START:CKEDITOR.END)}var s=/^[\r\n\t ]+$/,l=CKEDITOR.dom.walker.bookmark(!1,!0),c=CKEDITOR.dom.walker.whitespaces(!0),d=function(e){return l(e)&&c(e)},E={dd:1,dt:1,li:1};e.prototype={getNextParagraph:function(e){var r,n,a,o,c;if(e=e||"p",this._.nestedEditable){if(r=this._.nestedEditable.iterator.getNextParagraph(e))return this.activeFilter=this._.nestedEditable.iterator.activeFilter,r;if(this.activeFilter=this.filter,i(this,e,this._.nestedEditable.container,this._.nestedEditable.remaining))return this.activeFilter=this._.nestedEditable.iterator.activeFilter,this._.nestedEditable.iterator.getNextParagraph(e);this._.nestedEditable=null}if(!this.range.root.getDtd()[e])return null;this._.started||(n=t.call(this));var h=this._.nextNode,u=this._.lastNode;for(this._.nextNode=null;h;){var N=0,T=h.hasAscendant("pre"),f=h.type!=CKEDITOR.NODE_ELEMENT,O=0;if(f)h.type==CKEDITOR.NODE_TEXT&&s.test(h.getText())&&(f=0);else{var _=h.getName();if(CKEDITOR.dtd.$block[_]&&"false"==h.getAttribute("contenteditable")){i(this,e,r=h);break}if(h.isBlockBoundary(this.forceBrBreak&&!T&&{br:1})){if("br"==_)f=1;else if(!n&&!h.getChildCount()&&"hr"!=_){r=h,a=h.equals(u);break}n&&(n.setEndAt(h,CKEDITOR.POSITION_BEFORE_START),"br"!=_&&(this._.nextNode=h)),N=1}else{if(h.getFirst()){n||(n=this.range.clone()).setStartAt(h,CKEDITOR.POSITION_BEFORE_START),h=h.getFirst();continue}f=1}}if(f&&!n&&(n=this.range.clone()).setStartAt(h,CKEDITOR.POSITION_BEFORE_START),a=(!N||f)&&h.equals(u),n&&!N)for(;!h.getNext(d)&&!a;){var g=h.getParent();if(g.isBlockBoundary(this.forceBrBreak&&!T&&{br:1})){N=1,f=0,a=a||g.equals(u),n.setEndAt(g,CKEDITOR.POSITION_BEFORE_END);break}f=1,a=(h=g).equals(u),O=1}if(f&&n.setEndAt(h,CKEDITOR.POSITION_AFTER_END),h=this._getNextSourceNode(h,O,u),(a=!h)||N&&n)break}if(!r){if(!n)return this._.docEndMarker&&this._.docEndMarker.remove(),this._.nextNode=null,null;var k=new CKEDITOR.dom.elementPath(n.startContainer,n.root),I=k.blockLimit,R={div:1,th:1,td:1};if(!(r=k.block)&&I&&!this.enforceRealBlocks&&R[I.getName()]&&n.checkStartOfBlock()&&n.checkEndOfBlock()&&!I.equals(n.root))r=I;else if(!r||this.enforceRealBlocks&&r.is(E))r=this.range.document.createElement(e),n.extractContents().appendTo(r),r.trim(),n.insertNode(r),o=c=!0;else if("li"!=r.getName()){if(!n.checkStartOfBlock()||!n.checkEndOfBlock()){r=r.clone(!1),n.extractContents().appendTo(r),r.trim();var C=n.splitBlock();o=!C.wasStartOfBlock,c=!C.wasEndOfBlock,n.insertNode(r)}}else a||(this._.nextNode=r.equals(u)?null:this._getNextSourceNode(n.getBoundaryNodes().endNode,1,u))}if(o){var D=r.getPrevious();D&&D.type==CKEDITOR.NODE_ELEMENT&&("br"==D.getName()?D.remove():D.getLast()&&"br"==D.getLast().$.nodeName.toLowerCase()&&D.getLast().remove())}if(c){var m=r.getLast();m&&m.type==CKEDITOR.NODE_ELEMENT&&"br"==m.getName()&&(!CKEDITOR.env.needsBrFiller||m.getPrevious(l)||m.getNext(l))&&m.remove()}return this._.nextNode||(this._.nextNode=a||r.equals(u)||!u?null:this._getNextSourceNode(r,1,u)),r},_getNextSourceNode:function(e,t,r){function n(e){return!(e.equals(r)||e.equals(i))}var a,i=this.range.root;for(a=e.getNextSourceNode(t,null,n);!l(a);)a=a.getNextSourceNode(t,null,n);return a}},CKEDITOR.dom.range.prototype.createIterator=function(){return new e(this)}}();