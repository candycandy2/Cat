"use strict";!function(){function ToolbarModifier(t,o){AbstractToolbarModifier.call(this,t,o),this.removedButtons=null,this.originalConfig=null,this.actualConfig=null,this.emptyVisible=!1,this.state="edit",this.toolbarButtons=[{text:{active:"Hide empty toolbar groups",inactive:"Show empty toolbar groups"},group:"edit",position:"left",cssClass:"button-a-soft",clickCallback:function(t,o){t[t.hasClass("button-a-background")?"removeClass":"addClass"]("button-a-background"),this._toggleVisibilityEmptyElements(),this.emptyVisible?t.setText(o.text.active):t.setText(o.text.inactive)}},{text:"Add row separator",group:"edit",position:"left",cssClass:"button-a-soft",clickCallback:function(){this._addSeparator()}},{text:"Select config",group:"config",position:"left",cssClass:"button-a-soft",clickCallback:function(){this.configContainer.findOne("textarea").$.select()}},{text:"Back to configurator",group:"config",position:"right",cssClass:"button-a-background",clickCallback:function(){if("paste"===this.state){var t=this.configContainer.findOne("textarea").getValue();(t=ToolbarModifier.evaluateToolbarGroupsConfig(t))?this.setConfig(t):alert("Your pasted config is wrong.")}this.state="edit",this._showConfigurationTool(),this.showToolbarBtnsByGroupName(this.state)}},{text:'Get toolbar <span class="highlight">config</span>',group:"edit",position:"right",cssClass:"button-a-background icon-pos-left icon-download",clickCallback:function(){this.state="config",this._showConfig(),this.showToolbarBtnsByGroupName(this.state)}}],this.cachedActiveElement=null}var AbstractToolbarModifier=ToolbarConfigurator.AbstractToolbarModifier;ToolbarConfigurator.ToolbarModifier=ToolbarModifier,ToolbarModifier.prototype=Object.create(ToolbarConfigurator.AbstractToolbarModifier.prototype),ToolbarModifier.prototype.getActualConfig=function(){var t=AbstractToolbarModifier.prototype.getActualConfig.call(this);if(t.toolbarGroups)for(var o=t.toolbarGroups.length,e=0;e<o;e+=1){var r=t.toolbarGroups[e];t.toolbarGroups[e]=ToolbarModifier.parseGroupToConfigValue(r)}return t},ToolbarModifier.prototype._onInit=function(t,o,e){e=!0===e,AbstractToolbarModifier.prototype._onInit.call(this,void 0,o),this.removedButtons=[],e?this.actualConfig.removeButtons?this.removedButtons=this.actualConfig.removeButtons.split(","):this.removedButtons=[]:"removeButtons"in this.originalConfig?this.removedButtons=this.originalConfig.removeButtons?this.originalConfig.removeButtons.split(","):[]:(this.originalConfig.removeButtons="",this.removedButtons=[]),this.actualConfig.toolbarGroups||(this.actualConfig.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig()),this._fixGroups(this.actualConfig),this._calculateTotalBtns(),this._createModifier(),this._refreshMoveBtnsAvalibility(),this._refreshBtnTabIndexes(),"function"==typeof t&&t(this.mainContainer)},ToolbarModifier.prototype._showConfigurationTool=function(){this.configContainer.addClass("hidden"),this.modifyContainer.removeClass("hidden")},ToolbarModifier.prototype._showConfig=function(){var t=this,o=this.getActualConfig(),e={};if(o.toolbarGroups){e.toolbarGroups=o.toolbarGroups;var r=function(o,e){for(var r=[],i=o.length,n=0;n<i;n++){var a=o[n];if("/"!==a){if(e)for(var s=a.groups.length;s--;){var l=a.groups[s];0===ToolbarModifier.getTotalSubGroupButtonsNumber(l,t.fullToolbarEditor)&&a.groups.splice(s,1)}e&&0===a.groups.length||r.push(AbstractToolbarModifier.stringifyJSONintoOneLine(a,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0}))}else r.push("'/'")}return r}(o.toolbarGroups,this.cfg.trimEmptyGroups);e.toolbarGroups="\n\t\t"+r.join(",\n\t\t")}o.removeButtons&&(e.removeButtons=o.removeButtons);var i=['<textarea class="configCode" readonly>',"CKEDITOR.editorConfig = function( config ) {\n",e.toolbarGroups?"\tconfig.toolbarGroups = ["+e.toolbarGroups+"\n\t];":"",e.removeButtons?"\n\n":"",e.removeButtons?"\tconfig.removeButtons = '"+e.removeButtons+"';":"","\n};","</textarea>"].join("");this.modifyContainer.addClass("hidden"),this.configContainer.removeClass("hidden"),this.configContainer.setHtml(i)},ToolbarModifier.prototype._toggleVisibilityEmptyElements=function(){this.modifyContainer.hasClass("empty-visible")?(this.modifyContainer.removeClass("empty-visible"),this.emptyVisible=!1):(this.modifyContainer.addClass("empty-visible"),this.emptyVisible=!0),this._refreshMoveBtnsAvalibility()},ToolbarModifier.prototype._createModifier=function(){var t=this;AbstractToolbarModifier.prototype._createModifier.call(this),this.modifyContainer.setHtml(this._toolbarConfigToListString());var o=this.modifyContainer.find('li[data-type="group"]');this.modifyContainer.on("mouseleave",function(){this._dehighlightActiveToolGroup()},this);for(var e=o.count(),r=0;r<e;r+=1)o.getItem(r).on("mouseenter",function(){t._highlightGroup(this.data("name"))});return CKEDITOR.document.on("keypress",function(o){var e=o.data.$.keyCode,r=32===e||13===e,i=new CKEDITOR.dom.element(CKEDITOR.document.$.activeElement);i.getAscendant(function(o){return o.$===t.mainContainer.$})&&r&&"button"===i.data("type")&&i.findOne("input").$.click()}),this.modifyContainer.on("click",function(o){var e=o.data.$,r=new CKEDITOR.dom.element(e.target||e.srcElement),i=ToolbarModifier.getGroupOrSeparatorLiAncestor(r);if(i){if(t.cachedActiveElement=document.activeElement,r.$ instanceof HTMLInputElement)t._handleCheckboxClicked(r);else if(r.$ instanceof HTMLButtonElement){e.preventDefault?e.preventDefault():e.returnValue=!1;var n=t._handleAnchorClicked(r.$);if(n&&"remove"==n.action)return}var a=i.data("type"),s=i.data("name");t._setActiveElement(a,s),t.cachedActiveElement&&t.cachedActiveElement.focus()}}),this.toolbarContainer||(this._createToolbar(),this.toolbarContainer.insertBefore(this.mainContainer.getChildren().getItem(0))),this.showToolbarBtnsByGroupName("edit"),this.configContainer||(this.configContainer=new CKEDITOR.dom.element("div"),this.configContainer.addClass("configContainer"),this.configContainer.addClass("hidden"),this.mainContainer.append(this.configContainer)),this.mainContainer},ToolbarModifier.prototype.showToolbarBtnsByGroupName=function(t){if(this.toolbarContainer)for(var o=this.toolbarContainer.find("button"),e=o.count(),r=0;r<e;r+=1){var i=o.getItem(r);i.data("group")==t?i.removeClass("hidden"):i.addClass("hidden")}},ToolbarModifier.parseGroupToConfigValue=function(t){if("separator"==t.type)return"/";var o=t.groups,e=o.length;delete t.totalBtns;for(var r=0;r<e;r+=1)o[r]=o[r].name;return t},ToolbarModifier.getGroupOrSeparatorLiAncestor=function(t){return t.$ instanceof HTMLLIElement&&"group"==t.data("type")?t:ToolbarModifier.getFirstAncestor(t,function(t){var o=t.data("type");return"group"==o||"separator"==o})},ToolbarModifier.prototype._setActiveElement=function(t,o){if(this.currentActive&&this.currentActive.elem.removeClass("active"),null===t)return this._dehighlightActiveToolGroup(),void(this.currentActive=null);var e=this.mainContainer.findOne('ul[data-type=table-body] li[data-type="'+t+'"][data-name="'+o+'"]');e.addClass("active"),this.currentActive={type:t,name:o,elem:e},"group"==t&&this._highlightGroup(o),"separator"==t&&this._dehighlightActiveToolGroup()},ToolbarModifier.prototype.getActiveToolGroup=function(){return this.editorInstance.container?this.editorInstance.container.findOne(".cke_toolgroup.active, .cke_toolbar.active"):null},ToolbarModifier.prototype._dehighlightActiveToolGroup=function(){var t=this.getActiveToolGroup();t&&t.removeClass("active"),this.editorInstance.container&&this.editorInstance.container.removeClass("some-toolbar-active")},ToolbarModifier.prototype._highlightGroup=function(t){if(this.editorInstance.container){var o=this.getFirstEnabledButtonInGroup(t),e=this.editorInstance.container.findOne(".cke_button__"+o+", .cke_combo__"+o);if(this._dehighlightActiveToolGroup(),this.editorInstance.container&&this.editorInstance.container.addClass("some-toolbar-active"),e){var r=ToolbarModifier.getFirstAncestor(e,function(t){return t.hasClass("cke_toolbar")});r&&r.addClass("active")}}},ToolbarModifier.prototype.getFirstEnabledButtonInGroup=function(t){var o=this.actualConfig.toolbarGroups,e=this.getGroupIndex(t),r=o[e];if(-1===e)return null;for(var i=r.groups?r.groups.length:0,n=0;n<i;n+=1){var a=r.groups[n].name,s=this.getFirstEnabledButtonInSubgroup(a);if(s)return s}return null},ToolbarModifier.prototype.getFirstEnabledButtonInSubgroup=function(t){for(var o=this.fullToolbarEditor.buttonsByGroup[t],e=o?o.length:0,r=0;r<e;r+=1){var i=o[r].name;if(!this.isButtonRemoved(i))return i}return null},ToolbarModifier.prototype._handleCheckboxClicked=function(t){var o=t.getAscendant("li").data("name");!t.$.checked?this._addButtonToRemoved(o):this._removeButtonFromRemoved(o)},ToolbarModifier.prototype._handleAnchorClicked=function(t){var o,e,r,i=new CKEDITOR.dom.element(t),n=i.getAscendant("li"),a=n.getAscendant("ul"),s=n.data("type"),l=n.data("name"),u=i.data("direction"),d="up"===u?n.getPrevious():n.getNext();if(i.hasClass("disabled"))return null;if(i.hasClass("remove"))return n.remove(),this._removeSeparator(n.data("name")),this._setActiveElement(null),{action:"remove"};if(!i.hasClass("move")||!d)return{action:null};"group"!==s&&"separator"!==s||(o=l,r=this._moveGroup(u,o)),"subgroup"===s&&(e=l,o=n.getAscendant("li").data("name"),r=this._moveSubgroup(u,o,e)),"up"===u&&n.insertBefore(a.getChild(r)),"down"===u&&n.insertAfter(a.getChild(r));for(var f,c=n;c="up"===u?c.getPrevious():c.getNext();)if(this.emptyVisible||!c.hasClass("empty")){f=c;break}if(!f){var p='[data-direction="'+("up"===u?"down":"up")+'"]';this.cachedActiveElement=i.getParent().findOne(p)}return this._refreshMoveBtnsAvalibility(),this._refreshBtnTabIndexes(),{action:"move"}},ToolbarModifier.prototype._refreshMoveBtnsAvalibility=function(){function t(t){var e=t.count();for(i=0;i<e;i+=1)o._disableElementsInList(t.getItem(i))}for(var o=this,e=this.mainContainer.find("ul[data-type=table-body] li > p > span > button.move.disabled"),r=e.count(),i=0;i<r;i+=1)e.getItem(i).removeClass("disabled");t(this.mainContainer.find("ul[data-type=table-body]")),t(this.mainContainer.find("ul[data-type=table-body] > li > ul"))},ToolbarModifier.prototype._refreshBtnTabIndexes=function(){for(var t=this.mainContainer.find('[data-tab="true"]'),o=t.count(),e=0;e<o;e++){var r=t.getItem(e),i=r.hasClass("disabled");r.setAttribute("tabindex",i?-1:e)}},ToolbarModifier.prototype._disableElementsInList=function(t){function o(t){return!t.hasClass("empty")}if(t.getChildren().count()){var e,r;if(this.emptyVisible?(e=t.getFirst(),r=t.getLast()):(e=t.getFirst(o),r=t.getLast(o)),e)var i=e.findOne('p button[data-direction="up"]');if(r)var n=r.findOne('p button[data-direction="down"]');i&&(i.addClass("disabled"),i.setAttribute("tabindex","-1")),n&&(n.addClass("disabled"),n.setAttribute("tabindex","-1"))}},ToolbarModifier.prototype.getGroupIndex=function(t){for(var o=this.actualConfig.toolbarGroups,e=o.length,r=0;r<e;r+=1)if(o[r].name===t)return r;return-1},ToolbarModifier.prototype._addSeparator=function(){var t=this._determineSeparatorToAddIndex(),o=ToolbarModifier.createSeparatorLiteral(),e=CKEDITOR.dom.element.createFromHtml(ToolbarModifier.getToolbarSeparatorString(o));this.actualConfig.toolbarGroups.splice(t,0,o),e.insertBefore(this.modifyContainer.findOne("ul[data-type=table-body]").getChild(t)),this._setActiveElement("separator",o.name),this._refreshMoveBtnsAvalibility(),this._refreshBtnTabIndexes(),this._refreshEditor()},ToolbarModifier.prototype._removeSeparator=function(t){var o=CKEDITOR.tools.indexOf(this.actualConfig.toolbarGroups,function(o){return"separator"==o.type&&o.name==t});this.actualConfig.toolbarGroups.splice(o,1),this._refreshMoveBtnsAvalibility(),this._refreshBtnTabIndexes(),this._refreshEditor()},ToolbarModifier.prototype._determineSeparatorToAddIndex=function(){if(!this.currentActive)return 0;return("group"==this.currentActive.elem.data("type")||"separator"==this.currentActive.elem.data("type")?this.currentActive.elem:this.currentActive.elem.getAscendant("li")).getIndex()},ToolbarModifier.prototype._moveElement=function(t,o,e){var r,i=(r=this.emptyVisible?"down"==e?o+1:o-1:ToolbarModifier.getFirstElementIndexWith(t,o,e,function(t){return t.totalBtns||"separator"==t.type}))-o;return ToolbarModifier.moveTo(i,t,o)},ToolbarModifier.prototype._moveGroup=function(t,o){var e=this.getGroupIndex(o),r=this.actualConfig.toolbarGroups,i=this._moveElement(r,e,t);return this._refreshMoveBtnsAvalibility(),this._refreshBtnTabIndexes(),this._refreshEditor(),i},ToolbarModifier.prototype._moveSubgroup=function(t,o,e){var r=this.getGroupIndex(o),i=this.actualConfig.toolbarGroups[r],n=CKEDITOR.tools.indexOf(i.groups,function(t){return t.name==e}),a=this._moveElement(i.groups,n,t);return this._refreshEditor(),a},ToolbarModifier.prototype._calculateTotalBtns=function(){for(var t=this.actualConfig.toolbarGroups,o=t.length;o--;){var e=t[o],r=ToolbarModifier.getTotalGroupButtonsNumber(e,this.fullToolbarEditor);"separator"!=e.type&&(e.totalBtns=r)}},ToolbarModifier.prototype._addButtonToRemoved=function(t){if(-1!=CKEDITOR.tools.indexOf(this.removedButtons,t))throw"Button already added to removed";this.removedButtons.push(t),this.actualConfig.removeButtons=this.removedButtons.join(","),this._refreshEditor()},ToolbarModifier.prototype._removeButtonFromRemoved=function(t){var o=CKEDITOR.tools.indexOf(this.removedButtons,t);if(-1===o)throw"Trying to remove button from removed, but not found";this.removedButtons.splice(o,1),this.actualConfig.removeButtons=this.removedButtons.join(","),this._refreshEditor()},ToolbarModifier.parseGroupToConfigValue=function(t){if("separator"==t.type)return"/";var o=t.groups,e=o.length;delete t.totalBtns;for(var r=0;r<e;r+=1)o[r]=o[r].name;return t},ToolbarModifier.getGroupOrSeparatorLiAncestor=function(t){return t.$ instanceof HTMLLIElement&&"group"==t.data("type")?t:ToolbarModifier.getFirstAncestor(t,function(t){var o=t.data("type");return"group"==o||"separator"==o})},ToolbarModifier.createSeparatorLiteral=function(){return{type:"separator",name:"separator"+CKEDITOR.tools.getNextNumber()}},ToolbarModifier.prototype._toolbarConfigToListString=function(){for(var t=this.actualConfig.toolbarGroups||[],o='<ul data-type="table-body">',e=t.length,r=0;r<e;r+=1){var i=t[r];"separator"===i.type?o+=ToolbarModifier.getToolbarSeparatorString(i):o+=this._getToolbarGroupString(i)}return o+="</ul>",ToolbarModifier.getToolbarHeaderString()+o},ToolbarModifier.prototype._getToolbarGroupString=function(t){var o=t.groups,e="";e+=["<li ",'data-type="group" ','data-name="',t.name,'" ',t.totalBtns?"":'class="empty"',">"].join(""),e+=ToolbarModifier.getToolbarElementPreString(t)+"<ul>";for(var r=o.length,i=0;i<r;i+=1){var n=o[i],a=this.fullToolbarEditor.buttonsByGroup[n.name];e+=this._getToolbarSubgroupString(n,a)}return e+="</ul></li>"},ToolbarModifier.getToolbarSeparatorString=function(t){return["<li ",'data-type="',t.type,'" ','data-name="',t.name,'"',">",ToolbarModifier.getToolbarElementPreString("row separator"),"</li>"].join("")},ToolbarModifier.getToolbarHeaderString=function(){return'<ul data-type="table-header"><li data-type="header"><p>Toolbars</p><ul><li><p>Toolbar groups</p><p>Toolbar group items</p></li></ul></li></ul>'},ToolbarModifier.getFirstAncestor=function(t,o){for(var e=t.getParents(),r=e.length;r--;)if(o(e[r]))return e[r];return null},ToolbarModifier.getFirstElementIndexWith=function(t,o,e,r){for(;"up"===e?o--:++o<t.length;)if(r(t[o]))return o;return-1},ToolbarModifier.moveTo=function(t,o,e){var r,i;return-1!==e&&(r=o.splice(e,1)[0]),i=e+t,o.splice(i,0,r),i},ToolbarModifier.getTotalSubGroupButtonsNumber=function(t,o){var e="string"==typeof t?t:t.name,r=o.buttonsByGroup[e];return r?r.length:0},ToolbarModifier.getTotalGroupButtonsNumber=function(t,o){for(var e=0,r=t.groups,i=r?r.length:0,n=0;n<i;n+=1)e+=ToolbarModifier.getTotalSubGroupButtonsNumber(r[n],o);return e},ToolbarModifier.prototype._getToolbarSubgroupString=function(t,o){var e="";e+=["<li ",'data-type="subgroup" ','data-name="',t.name,'" ',t.totalBtns?"":'class="empty" ',">"].join(""),e+=ToolbarModifier.getToolbarElementPreString(t.name),e+="<ul>";for(var r=o?o.length:0,i=0;i<r;i+=1)e+=this.getButtonString(o[i]);return e+="</ul>",e+="</li>"},ToolbarModifier.prototype._getConfigButtonName=function(t){var o,e=this.fullToolbarEditor.editorInstance.ui.items;for(o in e)if(e[o].name==t)return o;return null},ToolbarModifier.prototype.isButtonRemoved=function(t){return-1!=CKEDITOR.tools.indexOf(this.removedButtons,this._getConfigButtonName(t))},ToolbarModifier.prototype.getButtonString=function(t){var o=this.isButtonRemoved(t.name)?"":'checked="checked"';return['<li data-tab="true" data-type="button" data-name="',this._getConfigButtonName(t.name),'">','<label title="',t.label,'" >',"<input ",'tabindex="-1"','type="checkbox"',o,"/>",t.$.getOuterHtml(),"</label>","</li>"].join("")},ToolbarModifier.getToolbarElementPreString=function(t){var o=t.name?t.name:t;return["<p>","<span>",'<button title="Move element upward" data-tab="true" data-direction="up" class="move icon-up-big"></button>','<button title="Move element downward" data-tab="true" data-direction="down" class="move icon-down-big"></button>',"row separator"==o?'<button title="Remove element" data-tab="true" class="remove icon-trash"></button>':"",o,"</span>","</p>"].join("")},ToolbarModifier.evaluateToolbarGroupsConfig=function(cfg){return cfg=function(cfg){var config={},result;try{result=eval("("+cfg+")")}catch(e){try{result=eval(cfg)}catch(t){return null}}return config.toolbarGroups&&"number"==typeof config.toolbarGroups.length?JSON.stringify(config):result&&"number"==typeof result.length?JSON.stringify({toolbarGroups:result}):result&&result.toolbarGroups?JSON.stringify(result):null}(cfg)}}();