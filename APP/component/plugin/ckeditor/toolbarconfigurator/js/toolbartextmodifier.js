"use strict";!function(){function t(t){o.call(this,t),this.codeContainer=null,this.hintContainer=null}var o=ToolbarConfigurator.AbstractToolbarModifier,r=ToolbarConfigurator.FullToolbarEditor;ToolbarConfigurator.ToolbarTextModifier=t,t.prototype=Object.create(o.prototype),t.prototype._onInit=function(t,r){o.prototype._onInit.call(this,void 0,r),this._createModifier(r?this.actualConfig:void 0),"function"==typeof t&&t(this.mainContainer)},t.prototype._createModifier=function(t){function e(t){var o=i(t);if(null!==o.charsBetween){var r=s.getUnusedButtonsArray(s.actualConfig.toolbar,!0,o.charsBetween),e=t.getCursor(),a=CodeMirror.Pos(e.line,e.ch-o.charsBetween.length),l=t.getTokenAt(e);if("{"===t.getTokenAt({line:e.line,ch:l.start}).string&&(r=["name"]),0!==r.length)return new n(a,e,r)}}function n(t,o,r){this.from=t,this.to=o,this.list=r,this._handlers=[]}function i(t,o){var r={};r.cur=t.getCursor(),r.tok=t.getTokenAt(r.cur),r.char=o||r.tok.string.charAt(r.tok.string.length-1);var e=t.getRange(CodeMirror.Pos(r.cur.line,0),r.cur).split("").reverse().join("");return e=e.replace(/(['|"]\w*['|"])/g,""),r.charsBetween=e.match(/(^\w*)(['|"])/),r.charsBetween&&(r.endChar=r.charsBetween[2],r.charsBetween=r.charsBetween[1].split("").reverse().join("")),r}function a(t){return setTimeout(function(){t.state.completionActive||CodeMirror.showHint(t,e,{hintsClass:"toolbar-modifier",completeSingle:!1})},100),CodeMirror.Pass}var s=this;this._createToolbar(),this.toolbarContainer&&this.mainContainer.append(this.toolbarContainer),o.prototype._createModifier.call(this),this._setupActualConfig(t);var l,u=this.actualConfig.toolbar;l=["CKEDITOR.editorConfig = function( config ) {\n",l=CKEDITOR.tools.isArray(u)?"\tconfig.toolbar = "+("[\n\t\t"+r.map(u,function(t){return o.stringifyJSONintoOneLine(t,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0})}).join(",\n\t\t")+"\n\t]")+";":"config.toolbar = [];","\n};"].join("");var c=new CKEDITOR.dom.element("div");c.addClass("codemirror-wrapper"),this.modifyContainer.append(c),this.codeContainer=CodeMirror(c.$,{mode:{name:"javascript",json:!0},lineNumbers:!1,lineWrapping:!0,viewportMargin:1/0,value:l,smartIndent:!1,indentWithTabs:!0,indentUnit:4,tabSize:4,theme:"neo",extraKeys:{Left:a,Right:a,"'''":a,"'\"'":a,Backspace:a,Delete:a,"Shift-Tab":"indentLess"}}),this.codeContainer.on("endCompletion",function(t,o){var r=i(t);void 0!==o&&t.replaceSelection(r.endChar)}),this.codeContainer.on("change",function(){var t=s.codeContainer.getValue();null!==(t=s._evaluateValue(t))?(s.actualConfig.toolbar=t.toolbar?t.toolbar:s.actualConfig.toolbar,s._fillHintByUnusedElements(),s._refreshEditor(),s.mainContainer.removeClass("invalid")):s.mainContainer.addClass("invalid")}),this.hintContainer=new CKEDITOR.dom.element("div"),this.hintContainer.addClass("toolbarModifier-hints"),this._fillHintByUnusedElements(),this.hintContainer.insertBefore(c)},t.prototype._fillHintByUnusedElements=function(){var t=this.getUnusedButtonsArray(this.actualConfig.toolbar,!0);t=this.groupButtonNamesByGroup(t);var o=r.map(t,function(t){var o=r.map(t.buttons,function(t){return"<code>"+t+"</code> "}).join("");return["<dt>","<code>",t.name,"</code>","</dt>","<dd>",o,"</dd>"].join("")}).join(" "),e=['<dt class="list-header">Toolbar group</dt>','<dd class="list-header">Unused items</dd>'].join("");t.length||(e="<p>All items are in use.</p>"),this.codeContainer.refresh(),this.hintContainer.setHtml("<h3>Unused toolbar items</h3><dl>"+e+o+"</dl>")},t.prototype.getToolbarGroupByButtonName=function(t){var o=this.fullToolbarEditor.buttonNamesByGroup;for(var r in o)for(var e=o[r],n=e.length;n--;)if(t===e[n])return r;return null},t.prototype.getUnusedButtonsArray=function(o,e,n){e=!0===e;var i=t.mapToolbarCfgToElementsList(o),a=Object.keys(this.fullToolbarEditor.editorInstance.ui.items);a=r.filter(a,function(t){var o="-"===t,r=void 0===n||0===t.toLowerCase().indexOf(n.toLowerCase());return!o&&r});var s=r.filter(a,function(t){return-1==CKEDITOR.tools.indexOf(i,t)});return e&&s.sort(),s},t.prototype.groupButtonNamesByGroup=function(t){var o=[],e=JSON.parse(JSON.stringify(this.fullToolbarEditor.buttonNamesByGroup));for(var n in e){var i=e[n];(i=r.filter(i,function(o){return-1!==CKEDITOR.tools.indexOf(t,o)})).length&&o.push({name:n,buttons:i})}return o},t.mapToolbarCfgToElementsList=function(t){for(var o=[],e=t.length,n=0;n<e;n+=1)t[n]&&"string"!=typeof t[n]&&(o=o.concat(r.filter(t[n].items,function(t){return"-"!==t})));return o},t.prototype._setupActualConfig=function(t){t=t||this.editorInstance.config,CKEDITOR.tools.isArray(t.toolbar)||(t.toolbarGroups||(t.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig(!0)),this._fixGroups(t),t.toolbar=this._mapToolbarGroupsToToolbar(t.toolbarGroups,this.actualConfig.removeButtons),this.actualConfig.toolbar=t.toolbar,this.actualConfig.removeButtons="")},t.prototype._mapToolbarGroupsToToolbar=function(t,o){o="string"==typeof(o=o||this.editorInstance.config.removedBtns)?o.split(","):[];for(var r=t.length;r--;){var e=this._mapToolbarSubgroup(t[r],o);"separator"!==t[r].type?CKEDITOR.tools.isArray(e)&&0===e.length?t.splice(r,1):t[r]="string"==typeof e?e:{name:t[r].name,items:e}:t[r]="/"}return t},t.prototype._mapToolbarSubgroup=function(t,o){var r=0;if("string"==typeof t)return t;for(var e=t.groups?t.groups.length:0,n=[],i=0;i<e;i+=1){var a=t.groups[i],s=this.fullToolbarEditor.buttonsByGroup["string"==typeof a?a:a.name]||[],l=(s=this._mapButtonsToButtonsNames(s,o)).length;r+=l,n=n.concat(s),l&&n.push("-")}return"-"==n[n.length-1]&&n.pop(),n},t.prototype._mapButtonsToButtonsNames=function(t,o){for(var r=t.length;r--;){var e,n=t[r];e="string"==typeof n?n:this.fullToolbarEditor.getCamelCasedButtonName(n.name),-1===CKEDITOR.tools.indexOf(o,e)?t[r]=e:t.splice(r,1)}return t},t.prototype._evaluateValue=function(t){var o;try{var r={};Function("var CKEDITOR = {}; "+t+"; return CKEDITOR;")().editorConfig(r);for(var e=(o=r).toolbar.length;e--;)o.toolbar[e]||o.toolbar.splice(e,1)}catch(t){o=null}return o},t.prototype.mapToolbarToToolbarGroups=function(t){function o(t,o){t=t.slice();for(var r=o.length;r--;){var e=t.indexOf(o[r]);-1!==e&&t.splice(e,1)}return t}for(var r={},e=[],n=[],i=t.length,a=0;a<i;a++)if("/"!==t[a]){var s=t[a].items,l={};l.name=t[a].name,l.groups=[];for(var u=s.length,c=0;c<u;c++){var f=s[c];if("-"!==f){var p=this.getToolbarGroupByButtonName(f);-1===l.groups.indexOf(p)&&l.groups.push(p),r[p]=r[p]||{};var h=r[p].buttons=r[p].buttons||{};h[f]=h[f]||{used:0,origin:l.name},h[f].used++}}n.push(l)}else n.push("/");return e=function(t,r){var e=[];for(var n in t){var i=t[n],a=r[n].slice();e=e.concat(o(a,Object.keys(i.buttons)))}return e}(r,this.fullToolbarEditor.buttonNamesByGroup),{toolbarGroups:n,removeButtons:e.join(",")}}}();